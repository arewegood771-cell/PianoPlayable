<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Playable Piano</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{margin:0;padding:0;background:#0d47a1;color:white;font-family:sans-serif;}
.piano-container{position:relative;width:100%;max-width:1200px;margin:auto;user-select:none;}
.white-key{display:inline-block;width:40px;height:200px;margin:1px;background:white;border:1px solid black;position:relative;z-index:1;cursor:pointer;}
.white-key.active{background:yellow;}
.black-key{position:absolute;width:25px;height:120px;background:black;top:0;z-index:2;cursor:pointer;margin-left:-12px;}
.black-key.active{background:orange;}
.controls{text-align:center;margin:10px;}
textarea{width:100%;height:80px;background:rgba(255,255,255,0.2);color:white;border:none;padding:5px;font-family:monospace;}
button{margin:5px;padding:5px 10px;background-purple-500 hover:bg-purple-600;color:white;border:none;border-radius:5px;cursor:pointer;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const Piano = () => {
  const [activeKeys, setActiveKeys] = React.useState(new Set());
  const [sheet, setSheet] = React.useState('');
  const [isPlaying, setIsPlaying] = React.useState(false);
  const audioCtxRef = React.useRef(null);
  const timeoutsRef = React.useRef([]);

  const generatePianoKeys = () => {
    const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const keys = [];
    for(let octave=3; octave<=5; octave++){
      for(let i=0;i<notes.length;i++){
        const note = notes[i];
        const isWhite = !note.includes('#');
        const freq = 440 * Math.pow(2, (octave - 4) + (i - 9)/12);
        keys.push({ note: note+octave, freq: freq, white: isWhite });
      }
    }
    return keys;
  };

  const keys = generatePianoKeys();

  React.useEffect(()=>{
    audioCtxRef.current = new (window.AudioContext||window.webkitAudioContext)();
    return ()=>{audioCtxRef.current.close();}
  },[]);

  const playNote = (freq,duration=400)=>{
    const ctx = audioCtxRef.current;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.frequency.value = freq;
    osc.type='sine';
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.7,ctx.currentTime);
    osc.start();
    osc.stop(ctx.currentTime+duration/1000);
  };

  const parseSheet = (sheetStr)=>{
    return sheetStr.trim().split(/\s+/).map(n=>{
      const [note,dur]=n.split('-');
      return {note:note.toUpperCase(),duration:parseInt(dur)||400};
    });
  };

  const playSheet = ()=>{
    if(!sheet.trim()) return alert('Masukin sheet dulu!');
    setIsPlaying(true);
    const notes=parseSheet(sheet);
    let delay=0;
    notes.forEach(n=>{
      const keyObj = keys.find(k=>k.note===n.note);
      if(keyObj){
        const t=setTimeout(()=>{
          playNote(keyObj.freq,n.duration);
          setActiveKeys(prev=>new Set(prev).add(n.note));
          setTimeout(()=>setActiveKeys(prev=>{
            const s = new Set(prev); s.delete(n.note); return s;
          }),n.duration);
        },delay);
        timeoutsRef.current.push(t);
        delay+=n.duration+50;
      }
    });
    setTimeout(()=>setIsPlaying(false),delay);
  };

  const stopPlayback = ()=>{
    setIsPlaying(false);
    timeoutsRef.current.forEach(t=>clearTimeout(t));
    timeoutsRef.current=[];
    setActiveKeys(new Set());
  };

  return <div className="piano-container">
    <div className="controls">
      <textarea placeholder="C4-400 D4-400 ..." value={sheet} onChange={e=>setSheet(e.target.value)} disabled={isPlaying}></textarea><br/>
      <button onClick={playSheet} disabled={isPlaying}>Play</button>
      <button onClick={stopPlayback} disabled={!isPlaying}>Stop</button>
    </div>
    <div style={{position:'relative',height:'220px'}}>
      {keys.map((k,i)=>{
        return k.white?
        <div key={k.note} className={`white-key ${activeKeys.has(k.note)?'active':''}`} onClick={()=>playNote(k.freq)}></div>
        :
        <div key={k.note} className={`black-key ${activeKeys.has(k.note)?'active':''}`} onClick={()=>playNote(k.freq)} style={{left:`${i*40-12}px`}}></div>
      })}
    </div>
  </div>;
};

ReactDOM.createRoot(document.getElementById('root')).render(<Piano/>);

</script>
</body>
</html>
